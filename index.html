<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>QCM Culture Incendie ‚Äì Fin de formation</title>

<style>
:root {
  --ok: #2e7d32;
  --ok-bg: #e8f5e9;
  --ko: #d32f2f;
  --ko-bg: #ffebee;
  --primary: #1976d2;
  --primary-bg: #e3f2fd;
  --text-main: #1f2937;
  --bg-card: #ffffff;
}
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: system-ui, -apple-system, sans-serif;
  background: #0f1115;
  color: var(--text-main);
  line-height: 1.5;
}
.bg {
  position: fixed;
  inset: 0;
  background: url("regiolis.jpg") center/cover no-repeat;
  z-index: -3;
}
.overlay {
  position: fixed;
  inset: 0;
  background: linear-gradient(180deg, rgba(15,17,21,0.85), rgba(15,17,21,0.65));
  z-index: -2;
}
.container {
  max-width: 700px;
  margin: 40px auto;
  padding: 0 20px;
}
.card {
  background: var(--bg-card);
  border-radius: 16px;
  padding: 30px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.4);
  animation: fadeIn 0.4s ease-out;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
h1 {
  color: #fff;
  text-align: center;
  font-size: 2rem;
  margin-bottom: 30px;
  text-shadow: 0 2px 4px rgba(0,0,0,0.5);
}
h2 { margin-top: 0; color: var(--text-main); }

/* Formulaire */
label.form-label {
  font-weight: 600;
  display: block;
  margin-top: 15px;
  color: #4b5563;
  font-size: 0.9rem;
}
input[type="text"], select, textarea {
  width: 100%;
  padding: 12px 15px;
  margin-top: 6px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  font-size: 1rem;
  transition: border-color 0.2s;
}
input[type="text"]:focus, select:focus, textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px var(--primary-bg);
}

/* Boutons */
button {
  width: 100%;
  padding: 14px;
  margin-top: 25px;
  font-weight: 700;
  font-size: 1rem;
  color: #fff;
  background: var(--primary);
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s, transform 0.1s;
}
button:hover:not(:disabled) { background: #1565c0; }
button:active:not(:disabled) { transform: scale(0.98); }
button:disabled { background: #9ca3af; cursor: not-allowed; }

/* Barre de progression */
.progress-container {
  background: #e5e7eb;
  height: 8px;
  border-radius: 4px;
  margin-bottom: 20px;
  overflow: hidden;
}
.progress-bar {
  background: var(--primary);
  height: 100%;
  width: 0%;
  transition: width 0.4s ease;
}
.q-header {
  display: flex;
  justify-content: space-between;
  color: #6b7280;
  font-size: 0.9rem;
  font-weight: 600;
  margin-bottom: 10px;
}
.question-text {
  font-size: 1.25rem;
  font-weight: 700;
  margin-bottom: 25px;
  color: #111827;
}

/* Options QCM */
.options label {
  display: flex;
  align-items: center;
  border: 2px solid #e5e7eb;
  padding: 15px 20px;
  border-radius: 10px;
  margin-bottom: 12px;
  cursor: pointer;
  transition: all 0.2s;
  background: #f9fafb;
  font-weight: 500;
}
.options label:hover {
  border-color: #d1d5db;
  background: #f3f4f6;
}
.options label:has(input:checked) {
  border-color: var(--primary);
  background: var(--primary-bg);
  color: #0d47a1;
}
.options input[type="radio"] { display: none; }

/* Utilitaires */
.danger { color: var(--ko); font-weight: 600; margin-top: 15px; font-size: 0.9rem; }
.correction-item {
  padding: 15px;
  border-radius: 8px;
  background: #f9fafb;
  margin-bottom: 15px;
  border-left: 4px solid #d1d5db;
}
.correction-item.correct { border-left-color: var(--ok); }
.correction-item.incorrect { border-left-color: var(--ko); }
.good { color: var(--ok); font-weight: 700; }
.bad { color: var(--ko); font-weight: 700; }
.score-display {
  font-size: 1.5rem;
  text-align: center;
  padding: 20px;
  background: var(--primary-bg);
  color: #0d47a1;
  border-radius: 8px;
  margin-bottom: 25px;
}
</style>
</head>

<body>
<div class="bg"></div>
<div class="overlay"></div>

<div class="container">
<h1>QCM Culture Incendie</h1>

<div id="startCard" class="card">
  <h2>Validation des acquis</h2>
  <label class="form-label">Service *</label>
  <select id="service">
    <option value="">‚Äî S√©lectionner votre service ‚Äî</option>
    <option>Escale</option>
    <option>ASCT</option>
    <option>Vente / Accueil</option>
    <option>S√ªret√©</option>
    <option>Maintenance / Technique</option>
    <option>Gares & Connexions</option>
  </select>

  <label class="form-label">Nom *</label>
  <input type="text" id="nom" placeholder="Votre nom">
  
  <label class="form-label">Pr√©nom *</label>
  <input type="text" id="prenom" placeholder="Votre pr√©nom">

  <label class="form-label">Code de session *</label>
  <input type="text" id="code" placeholder="Code communiqu√© par le formateur">

  <div id="startError" class="danger" style="display:none">
    ‚ö†Ô∏è Tous les champs sont obligatoires et le code doit √™tre valide.
  </div>

  <button id="startBtn">D√©marrer l'√©valuation</button>
</div>

<div id="quizCard" class="card" style="display:none">
  <div class="q-header">
    <span>Question <span id="qIndex"></span> sur 12</span>
  </div>
  <div class="progress-container">
    <div id="progressBar" class="progress-bar"></div>
  </div>
  
  <div id="question" class="question-text"></div>
  <div id="options" class="options"></div>
  
  <button id="nextBtn" disabled>Valider et Continuer</button>
</div>

<div id="orderCard" class="card" style="display:none">
  <div class="q-header">
    <span>Question 13 sur 13 - Pas √† pas de Bayonne</span>
  </div>
  <div class="progress-container">
    <div class="progress-bar" style="width: 100%;"></div>
  </div>
  
  <div class="question-text">Classez ces actions dans l'ordre chronologique de la proc√©dure en cas d'alarme :</div>
  <p style="font-size: 0.9rem; color: #6b7280; margin-top: -15px; margin-bottom: 20px;">Utilisez les fl√®ches pour monter ou descendre les √©tapes.</p>
  
  <div id="sortableList"></div>
  
  <button id="validateOrderBtn">Valider l'ordre et Terminer</button>
</div>

<div id="sendCard" class="card" style="display:none">
  <h2>√âvaluation termin√©e !</h2>
  <p>Merci d'avoir r√©pondu √† toutes les questions.</p>
  
  <label class="form-label">Remarque ou retour sur la formation (optionnel)</label>
  <textarea id="commentaire" rows="4" placeholder="Partagez votre avis ou vos questions √©ventuelles..."></textarea>
  
  <button id="sendBtn">Envoyer et voir ma correction</button>
  <p id="sendInfo" style="text-align:center; margin-top:10px; font-weight:600;"></p>
</div>

<div id="correctionCard" class="card" style="display:none">
  <h2>Bilan de la session</h2>
  <div id="score" class="score-display"></div>
  <div id="details"></div>
</div>

</div>

<script>
/* CONFIG */
const CODE_SESSION = "escalebayonne";
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwmsKnIF0TcKtKYAnwg0XetWkUiorxTJuBYW6gw6zbTohBUhvI1b5bJO9ladR-zssG2/exec";

/* TEXTES DU PAS √Ä PAS DE BAYONNE BAS√â SUR LE DOCUMENT FOURNI */
const ETAPES_BAYONNE = [
  "Arr√™ter le signal sonore du SDI",
  "Arr√™ter le signal sonore du SMSI",
  "Lire la localisation de l'alarme et prendre les plans",
  "Se rendre sur les lieux pour faire la lev√©e de doute",
  "Alerter les secours, √©vacuer et accueillir les pompiers"
];

/* QUESTIONS QCM */
const QUESTIONS = [
  { q: "En gare, quelle est votre premi√®re action sur la centrale SSI lors du d√©clenchement d'une alarme incendie ?", o: ["Se rendre imm√©diatement sur la zone concern√©e", "Arr√™ter le signal sonore pour analyser la situation", "R√©armer imm√©diatement le syst√®me", "Appeler les secours ext√©rieurs (18/112)"], c: 1 },
  { q: "Quelle information cruciale devez-vous identifier en priorit√© sur l'√©cran de la centrale SSI ?", o: ["L'historique des derni√®res alarmes", "La localisation pr√©cise de l'√©v√©nement (zone et local)", "Votre niveau d'acc√®s actuel", "L'heure exacte du d√©clenchement"], c: 1 },
  { q: "Comment confirmez-vous visuellement qu'un d√©tecteur ou un d√©clencheur manuel est bien en alarme ?", o: ["Il √©met une lumi√®re verte continue", "Son voyant rouge est allum√© ou clignotant", "Il √©met un signal sonore strident", "Son √©tiquette d'identification a chang√© de couleur"], c: 1 },
  { q: "Face √† un feu confirm√© ou en cas de doute s√©rieux, quelle est la priorit√© absolue ?", o: ["R√©armer le Syst√®me de S√©curit√© Incendie (SSI)", "Poursuivre seul la lev√©e de doute de mani√®re exhaustive", "Mettre en s√©curit√© les personnes et donner l'alerte", "Attendre l'arriv√©e du personnel d'astreinte"], c: 2 },
  { q: "Quelle est la r√®gle fondamentale concernant l'alarme sonore d'√©vacuation en gare ?", o: ["Elle peut √™tre arr√™t√©e d√®s que l'incident est identifi√©", "Elle facilite la communication lors de la lev√©e de doute", "Elle doit rester active jusqu'√† la fin compl√®te de l'√©vacuation", "Elle s'arr√™te automatiquement apr√®s 5 minutes"], c: 2 },
  { q: "Que permet de faire le passage au niveau 2 d'acc√®s sur le SMSI ?", o: ["D√©clencher l'√©vacuation g√©n√©rale", "Acc√©der aux commandes de gestion et de mise en s√©curit√©", "Neutraliser d√©finitivement l'alarme", "Couper l'alimentation du SDI"], c: 1 },
  { q: "Quelle est la fonction principale du SDI (Syst√®me de D√©tection Incendie) ?", o: ["Agir physiquement sur le b√¢timent (portes, ventilation)", "D√©tecter un d√©part de feu et le signaler √† la centrale", "Commander automatiquement le d√©senfumage", "G√©rer et diffuser le message d'√©vacuation"], c: 1 },
  { q: "Dans le cadre du SSI, quel √©quipement pilote la fonction de d√©senfumage ?", o: ["L'agent terrain via une commande locale", "Le Syst√®me de D√©tection Incendie (SDI)", "Le Syst√®me de Mise en S√©curit√© Incendie (SMSI)", "Les sapeurs-pompiers exclusivement"], c: 2 },
  { q: "En situation de crise incendie, quelle est la priorit√© absolue du Chef d‚Äô√âquipe d'Intervention (CEV) ?", o: ["Assurer la continuit√© du service ferroviaire", "Prot√©ger le mat√©riel et les infrastructures", "Garantir la s√©curit√© et l'√©vacuation des personnes", "Proc√©der √† la remise en service du SSI"], c: 2 },
  { q: "√Ä l'arriv√©e des sapeurs-pompiers, quel est le r√¥le prioritaire du CEV ?", o: ["Diriger les op√©rations d'extinction avec eux", "Intervenir directement sur le foyer de l'incendie", "Les accueillir, les orienter et leur transmettre les informations", "R√©armer le syst√®me pour stopper les alarmes"], c: 2 },
  { q: "Quels sont les num√©ros d'urgence officiels √† composer en cas d'incendie ?", o: ["Le 17 (Police) et le 112 (Urgence Europ√©enne)", "Le 18 (Pompiers) et le 112 (Urgence Europ√©enne)", "Le 15 (SAMU) et le 18 (Pompiers)", "Uniquement le 112"], c: 1 },
  { q: "Quelle information est la plus importante √† transmettre lors de l'appel aux sapeurs-pompiers ?", o: ["La cause suppos√©e du d√©part de feu", "La localisation pr√©cise de l'incendie et son √©volution", "Le nom et le matricule du chef d'escale", "L'impact imm√©diat sur la circulation des trains"], c: 1 }
];

let idx = 0, answers = [];
let currentOrder = [...ETAPES_BAYONNE].sort(() => Math.random() - 0.5); // M√©lange l'ordre de base
let orderResult = false;
const $ = id => document.getElementById(id);

/* ACC√àS */
$("startBtn").onclick = () => {
  if (!$("service").value || !$("nom").value || !$("prenom").value || $("code").value !== CODE_SESSION) {
    $("startError").style.display = "block";
    return;
  }
  $("startError").style.display = "none";
  $("startCard").style.display = "none";
  $("quizCard").style.display = "block";
  render();
};

function render() {
  $("qIndex").textContent = idx + 1;
  const progressPercent = (idx / (QUESTIONS.length + 1)) * 100;
  $("progressBar").style.width = progressPercent + "%";
  
  $("question").textContent = QUESTIONS[idx].q;
  $("options").innerHTML = "";
  
  QUESTIONS[idx].o.forEach((t, i) => {
    const l = document.createElement("label");
    l.innerHTML = `<input type="radio" name="opt" value="${i}"> ${t}`;
    $("options").appendChild(l);
  });
  
  $("nextBtn").disabled = true;
  $("options").onchange = () => $("nextBtn").disabled = false;
}

$("nextBtn").onclick = () => {
  const sel = [...document.getElementsByName("opt")].find(r => r.checked);
  answers.push(sel ? +sel.value : null);
  idx++;
  
  if (idx === QUESTIONS.length) {
    $("quizCard").style.display = "none";
    $("orderCard").style.display = "block";
    renderOrder();
  } else {
    $("quizCard").style.animation = 'none';
    $("quizCard").offsetHeight; 
    $("quizCard").style.animation = 'fadeIn 0.3s ease-out';
    render();
  }
};

/* LOGIQUE QUESTION ORDRE CHRONO */
function renderOrder() {
  const list = $("sortableList");
  list.innerHTML = "";
  currentOrder.forEach((step, i) => {
    list.innerHTML += `
      <div style="display:flex; align-items:center; background:#f9fafb; border:2px solid #e5e7eb; border-radius:10px; margin-bottom:10px; padding:12px 15px;">
        <div style="flex:1; font-weight:500; font-size:1rem; color:#111827;">${step}</div>
        <div style="display:flex; flex-direction:column; gap:6px; margin-left:15px;">
          <button onclick="moveUp(${i})" style="margin:0; padding:8px 12px; border-radius:6px; background:${i===0?'#e5e7eb':'var(--primary)'}; color:${i===0?'#9ca3af':'#fff'}; font-size:1.2rem;" ${i===0?'disabled':''}>‚ñ≤</button>
          <button onclick="moveDown(${i})" style="margin:0; padding:8px 12px; border-radius:6px; background:${i===currentOrder.length-1?'#e5e7eb':'var(--primary)'}; color:${i===currentOrder.length-1?'#9ca3af':'#fff'}; font-size:1.2rem;" ${i===currentOrder.length-1?'disabled':''}>‚ñº</button>
        </div>
      </div>
    `;
  });
}

function moveUp(i) {
  if (i > 0) {
    [currentOrder[i-1], currentOrder[i]] = [currentOrder[i], currentOrder[i-1]];
    renderOrder();
  }
}

function moveDown(i) {
  if (i < currentOrder.length - 1) {
    [currentOrder[i+1], currentOrder[i]] = [currentOrder[i], currentOrder[i+1]];
    renderOrder();
  }
}

$("validateOrderBtn").onclick = () => {
  orderResult = currentOrder.every((val, index) => val === ETAPES_BAYONNE[index]);
  $("orderCard").style.display = "none";
  $("sendCard").style.display = "block";
};

/* ENVOI */
$("sendBtn").onclick = async () => {
  const score = answers.filter((a, i) => a === QUESTIONS[i].c).length;
  const infoOrder = orderResult ? "[‚úîÔ∏è Chronologie : CORRECTE]" : "[‚ùå Chronologie : INCORRECTE]";
  
  const payload = {
    nom: $("nom").value,
    prenom: $("prenom").value,
    service: $("service").value,
    score: score + "/12",
    details: answers,
    commentaire: infoOrder + "\n\n" + $("commentaire").value,
    userAgent: navigator.userAgent
  };

  $("sendBtn").disabled = true;
  $("sendInfo").textContent = "Transmission des r√©ponses en cours...";

  try {
    await fetch(APPS_SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify(payload),
      mode: "no-cors"
    });
  } catch (e) {
    console.error("Erreur d'envoi:", e);
  }

  showCorrection(score);
};

function showCorrection(score) {
  $("sendCard").style.display = "none";
  $("correctionCard").style.display = "block";
  $("score").innerHTML = `<strong>Score QCM : ${score} / 12</strong>`;
  $("details").innerHTML = "";

  // 1. Affichage des questions classiques en premier
  QUESTIONS.forEach((q, i) => {
    const ok = answers[i] === q.c;
    const div = document.createElement("div");
    div.className = `correction-item ${ok ? 'correct' : 'incorrect'}`;
    div.innerHTML = `
      <p style="margin-top:0; font-weight:600;">Question ${i + 1} : ${q.q}</p>
      <p style="margin-bottom:5px;">
        <span class="${ok ? "good" : "bad"}">
          ${ok ? "‚úì" : "‚úó"} Ta r√©ponse : ${q.o[answers[i]] || "Aucune r√©ponse"}
        </span>
      </p>
      ${!ok ? `<p style="margin-top:0;"><span class="good">üí° Bonne r√©ponse : ${q.o[q.c]}</span></p>` : ""}
    `;
    $("details").appendChild(div);
  });
  
  // 2. Affichage du r√©sultat de la question Chrono en DERNIER
  const divBonus = document.createElement("div");
  divBonus.className = `correction-item ${orderResult ? 'correct' : 'incorrect'}`;
  const bonneReponseHTML = ETAPES_BAYONNE.map((s,i) => `<strong>${i+1}.</strong> ${s}`).join('<br>');
  divBonus.innerHTML = `
    <p style="margin-top:0; font-weight:600;">Question 13 : Proc√©dure de Bayonne</p>
    <p style="margin-bottom:5px;">
      <span class="${orderResult ? 'good' : 'bad'}">
        ${orderResult ? '‚úì Parfait, l\'ordre chronologique est ma√Ætris√© !' : '‚úó L\'ordre des actions n\'√©tait pas le bon.'}
      </span>
    </p>
    ${!orderResult ? `<p style="margin-top:10px;"><span class="good">üí° L'ordre correct √©tait :<br>${bonneReponseHTML}</span></p>` : ''}
  `;
  $("details").appendChild(divBonus);
}
</script>
</body>
</html>
