<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QCM Culture Incendie – Fin de formation</title>

<style>
:root {
  --card-bg: rgba(255,255,255,0.96);
  --accent:#111;
  --sncf-blue:#0088ce;
  --border:rgba(0,0,0,0.1);
  --ok:#2e7d32;
  --ko:#d32f2f;
}
*{box-sizing:border-box}
body{
  font-family:system-ui,-apple-system,sans-serif;
  margin:0;min-height:100vh;
  background:#0f1115;color:#111;
}
.bg{
  position:fixed;inset:0;
  background:url("regiolis.jpg") center/cover no-repeat;
  z-index:-3;
}
.overlay{
  position:fixed;inset:0;
  background:linear-gradient(180deg,rgba(0,0,0,.7),rgba(0,0,0,.5));
  z-index:-2;
}
.container{
  max-width:800px;margin:auto;padding:20px 15px;
}
h1{color:#fff;text-align:center;margin-bottom:5px}
.muted{color:#eee;text-align:center;margin-bottom:20px}
.card{
  background:var(--card-bg);
  border-radius:16px;
  padding:20px;margin-bottom:15px;
  box-shadow:0 10px 25px rgba(0,0,0,.3);
}
label{font-weight:700;margin-top:10px;display:block}
input,select,textarea{
  width:100%;padding:12px;border-radius:8px;
  border:1px solid var(--border);margin-bottom:10px;
}
button{
  width:100%;padding:14px;border-radius:10px;
  border:none;background:var(--accent);
  color:#fff;font-weight:700;cursor:pointer;
}
button.secondary{
  background:#fff;color:#111;border:1px solid #ccc;
}
button:disabled{opacity:.4;cursor:not-allowed}
.options label{
  display:flex;align-items:center;
  padding:12px;border:1px solid #ddd;
  border-radius:10px;margin-bottom:10px;
}
.options input{transform:scale(1.3);margin-right:12px}
.danger{color:var(--ko);font-weight:700}
.ok{color:var(--ok);font-weight:700}
.correction-item{
  border-bottom:1px solid #ddd;padding:10px 0;
}
.good{color:var(--ok);font-weight:700}
.bad{color:var(--ko);font-weight:700}
.mail-btn{
  background:var(--sncf-blue);
  text-decoration:none;color:#fff;
  display:block;text-align:center;
  padding:14px;border-radius:10px;
  font-weight:700;margin-top:15px;
}
</style>
</head>

<body>
<div class="bg"></div>
<div class="overlay"></div>

<div class="container">
<h1>QCM Culture Incendie</h1>
<p class="muted">Fin de formation – SSI Gare de Bayonne</p>

<!-- START -->
<div id="startCard" class="card">
<label>Service d’origine *</label>
<select id="serviceOrigin" required>
  <option value="">— Sélectionner —</option>
  <option>Escale</option>
  <option>Vente / Accueil</option>
  <option>ASCT</option>
  <option>Conducteur</option>
  <option>Sûreté</option>
  <option>Maintenance / Technique</option>
  <option>Gares & Connexions</option>
</select>

<label>Nom *</label>
<input id="lastName" required />
<label>Prénom *</label>
<input id="firstName" required />

<button id="startBtn">Démarrer le QCM</button>
<p id="startWarn" class="danger" style="display:none">
Nom, prénom et service sont obligatoires.
</p>
</div>

<!-- QUIZ -->
<div id="quizCard" class="card" style="display:none">
<p><strong>Question <span id="qIndex">1</span>/12</strong></p>
<div id="questionText"></div>
<div id="options" class="options"></div>
<button id="nextBtn" disabled>Valider & Suivant</button>
<button id="skipBtn" class="secondary">Passer</button>
</div>

<!-- FINAL -->
<div id="finalCard" class="card" style="display:none">
<label>Remarque / retour (optionnel)</label>
<textarea id="freeText"></textarea>
<button id="sendBtn">Envoyer mes réponses</button>
<p id="sendStatus"></p>
<div id="sendErr"></div>
</div>

<!-- CORRECTION -->
<div id="correctionCard" class="card" style="display:none">
<h2>Correction</h2>
<p id="scoreLine"></p>
<div id="corrections"></div>
</div>
</div>

<script>
const APPS_SCRIPT_URL="https://script.google.com/macros/s/AKfycbx0kqt1t0nhy3DVU6iJ4vQT4vDLfv_Gz7Jdoha3Ydx-FZdK8KAhdmQa73A3_VTMPt6xKA/exec";
const MON_EMAIL="Ludovic.klein2@sncf.fr";

const QUESTIONS=[
{t:"Première action lors d’une alarme incendie ?",o:["Aller sur zone","Arrêter le signal sonore SDI","Réarmer","Appeler les pompiers"],c:1},
{t:"Information à lire en priorité ?",o:["Historique","Zonage / localisation","Niveau accès","Date"],c:1},
{t:"Voyant d’un DM ou détecteur en alarme ?",o:["Vert","Rouge clignotant","Orange","Bleu"],c:1},
{t:"En cas de feu avéré ?",o:["Réarmer","Attendre","Appliquer procédures d’urgence","Couper élec"],c:2},
{t:"Réarmement DM autorisé si ?",o:["Toujours","Fausse alarme confirmée","Avant levée doute","Sur ordre"],c:1},
{t:"Niveau 2 SMSI permet ?",o:["Évacuation","Neutralisation","Accès réarmement","Coupure SDI"],c:2},
{t:"Rôle du SDI ?",o:["Agir","Détecter","Évacuer","Commander DAS"],c:1},
{t:"Rôle du SMSI ?",o:["Détecter","Informer","Piloter les DAS","Éteindre"],c:2},
{t:"Réarmement complet SSI possible si ?",o:["Alarme stoppée","Doute levé","DAS remis en attente","CEV présent"],c:2},
{t:"Priorité du CEV ?",o:["Matériel","Service","Personnes","Délais"],c:2},
{t:"Mission du CEV face aux secours ?",o:["Commander","Intervenir","Accueillir et informer","Éteindre"],c:2},
{t:"Levée de doute :",o:["Toujours seul","Avec risque","Sans se mettre en danger","En courant"],c:2}
];

const $=id=>document.getElementById(id);
let idx=0,answers=[],resp={};

function renderQ(){
  const q=QUESTIONS[idx];
  $("qIndex").textContent=idx+1;
  $("questionText").textContent=q.t;
  $("options").innerHTML="";
  q.o.forEach((txt,i)=>{
    const l=document.createElement("label");
    l.innerHTML=`<input type="radio" name="opt" value="${i}"> ${txt}`;
    $("options").appendChild(l);
  });
  $("nextBtn").disabled=true;
  $("options").onchange=()=>$("nextBtn").disabled=false;
}

$("startBtn").onclick=()=>{
  if(!$("serviceOrigin").value||!$("lastName").value||!$("firstName").value){
    $("startWarn").style.display="block";return;
  }
  resp.service=$("serviceOrigin").value;
  resp.nom=$("lastName").value+" "+$("firstName").value;
  $("startCard").style.display="none";
  $("quizCard").style.display="block";
  renderQ();
};

$("nextBtn").onclick=()=>{
  const sel=[...document.getElementsByName("opt")].find(r=>r.checked);
  answers.push({s:sel?+sel.value:null});
  idx++;
  if(idx>=QUESTIONS.length){
    $("quizCard").style.display="none";
    $("finalCard").style.display="block";
  }else renderQ();
};

$("skipBtn").onclick=()=>{
  answers.push({s:null});
  $("nextBtn").onclick();
};

$("sendBtn").onclick=async()=>{
  const score=answers.filter((a,i)=>a.s===QUESTIONS[i].c).length;
  const payload={
    nom:resp.nom,
    service:resp.service,
    score:score+"/12",
    details:answers,
    commentaire:$("freeText").value
  };
  try{
    await fetch(APPS_SCRIPT_URL,{method:"POST",mode:"no-cors",body:JSON.stringify(payload)});
    showCorrection(score);
  }catch{
    window.location=`mailto:${MON_EMAIL}?subject=Résultats QCM Incendie&body=${encodeURIComponent(JSON.stringify(payload,null,2))}`;
    showCorrection(score);
  }
};

function showCorrection(score){
  $("finalCard").style.display="none";
  $("correctionCard").style.display="block";
  $("scoreLine").innerHTML=`<strong>Score :</strong> ${score}/12`;
  const ctn=$("corrections");
  ctn.innerHTML="";
  QUESTIONS.forEach((q,i)=>{
    const div=document.createElement("div");
    const good=q.o[q.c];
    const sel=answers[i].s!==null?q.o[answers[i].s]:"Aucune réponse";
    div.className="correction-item";
    div.innerHTML=`
      <strong>Q${i+1}.</strong> ${q.t}<br>
      <span class="${answers[i].s===q.c?"good":"bad"}">Ta réponse : ${sel}</span><br>
      <span class="good">Bonne réponse : ${good}</span>`;
    ctn.appendChild(div);
  });
}
</script>
</body>
</html>
